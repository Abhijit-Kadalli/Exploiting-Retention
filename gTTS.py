from gtts import gTTS
import os
import random
from mutagen.mp3 import MP3
import json
from moviepy.editor import concatenate_audioclips, AudioFileClip

path = "comment_screenshots"

directories = os.listdir(path)

tts = []

for directory in directories:
    if directory != ".DS_Store":
        with open(path + "/" + directory + "/" + "comments.txt", 'r') as f:
            lines = f.readlines()
            for line in lines:
                if line[0] != "\n":
                    line = line.replace("\n", "")
                    tts.append(line)

speeches = []
narrator_accent = random.choice(['com.au','co.uk','us','ca','co.in','ie','co.za'])

for speech in tts:
        tts = gTTS(text=speech, lang='en', tld=narrator_accent, slow=False)
        speeches.append(tts)

for dir in directories:
    dirs = os.listdir(os.path.join(path,dir))
    clips = []
    clip_info_json = []
    for audio_name in dirs:
        if audio_name != "comments.txt":
            audio_name = audio_name.replace(".png", ".mp3")
            audio_path = os.path.join(os.path.join(path,dir),audio_name)
            speeches.pop(0).save(audio_path)
            audio = MP3(audio_path)
            clip_info_json.append(
                    {
                    "path": audio_path.replace(".mp3", ".png"),
                    "duration": audio.info.length
                    }
                )
            clips.append(AudioFileClip(audio_path))
    save_json = open(os.path.join(os.path.join(path,dir),"clip_info.json"), "w")
    json.dump(clip_info_json, save_json, indent=4)
    save_json.close()
    final_clip = concatenate_audioclips(clips)
    final_clip.write_audiofile(os.path.join(os.path.join(path,dir),"all_comments.mp3"))

